var flagDataList = [
    { text: "把科学防脱提上日程", isChecked: false },
    { text: "暴富！！！", isChecked: false },
    { text: "去芬兰追极光", isChecked: false },
    { text: "绝对不熬夜了", isChecked: false },
    { text: "去日本看樱花", isChecked: false },
    { text: "变瘦变美！", isChecked: false },
    { text: "多给爸妈打电话", isChecked: false },
    { text: "世界和平！", isChecked: false },
    { text: "每顿少吃一口饭", isChecked: false },
    { text: "再喝奶茶我是狗", isChecked: false },
    { text: "再也不挤痘了", isChecked: false },
    { text: "再也不裸考了", isChecked: false },
    { text: "去现场看爱豆！", isChecked: false },
    { text: "学会理财，绝不乱花！", isChecked: false },
    { text: "每天至少花10分钟学英语", isChecked: false },
    { text: "再也不深夜思考人生了", isChecked: false },
    { text: "和家人一起去旅行", isChecked: false },
    { text: "立个Flag，再也不立Flag了", isChecked: false },
    { text: "别过得像2018就行", isChecked: false },
    { text: "每天坚持走10000步", isChecked: false },
    { text: "一定要在12点前睡觉", isChecked: false },
    { text: "不再视奸前任的微博", isChecked: false },
    { text: "写出N篇10W+文章", isChecked: false },
    { text: "考上研究生", isChecked: false },
    { text: "去现场看一场球赛", isChecked: false },
    { text: "练出马甲线", isChecked: false },
    { text: "去现场看易烊千玺跳舞", isChecked: false },
    { text: "每天喝够8杯水", isChecked: false },
    { text: "去北海道滑雪", isChecked: false },
    { text: "一定要戒掉甜食！", isChecked: false },
    { text: "今年保证不脱粉", isChecked: false },
    { text: "不会再取悦任何人", isChecked: false },
    { text: "不用完一支口红，不买下一支", isChecked: false },
    { text: "每周都去健身房", isChecked: false },
    { text: "种一棵树", isChecked: false },
    { text: "绝不为垃圾游戏氪金", isChecked: false },
    { text: "多认识一些新朋友", isChecked: false },
    { text: "再也不蹦迪了", isChecked: false },
    { text: "一定能自学吉他", isChecked: false },
    { text: "再长高3公分", isChecked: false },
    { text: "戒掉夜宵", isChecked: false },
    { text: "再次见证IG拿冠军", isChecked: false },
    { text: "不谈恋爱只发财", isChecked: false },
    { text: "跑一场半马", isChecked: false },
    { text: "拿到教师资格证", isChecked: false },
    { text: "学会拒绝和说“不”", isChecked: false },
    { text: "认真学习不翘课", isChecked: false },
    { text: "一个月至少去一次电影院", isChecked: false },
    { text: "实现财务自由", isChecked: false },
    { text: "六级低分飘过！", isChecked: false },
    { text: "去西藏感受心灵净化", isChecked: false },
    { text: "再买皮肤我剁手！", isChecked: false },
    { text: "高考超常发挥！", isChecked: false },
    { text: "认真护肤", isChecked: false },
    { text: "去南极看北极熊", isChecked: false },
    { text: "考上公务员", isChecked: false },
    { text: "比2018更可爱", isChecked: false },
    { text: "拥有一只狗子", isChecked: false },
    { text: "看一次日出", isChecked: false },
    { text: "去故宫看一场雪", isChecked: false },
    { text: "再刷一遍《生活大爆炸》", isChecked: false },
    { text: "戒甜戒辣戒油腻", isChecked: false },
    { text: "一次考过驾照！", isChecked: false },
    { text: "绝不主动给他发微信", isChecked: false },
    { text: "参加一次Color Run", isChecked: false },
    { text: "囤枸杞，开始养生", isChecked: false },
    { text: "去尝试剪一次短发", isChecked: false },
    { text: "减少焦虑，保持好心态", isChecked: false },
    { text: "不做舔狗", isChecked: false },
    { text: "上厕所绝不带手机", isChecked: false },
    { text: "重新开始更新公众号", isChecked: false },
    { text: "完成KPI", isChecked: false },
    { text: "微信不要再发错群了", isChecked: false },
    { text: "不能再错发沙雕表情包给领导", isChecked: false },
    { text: "多陪伴家人", isChecked: false },
    { text: "少打游戏，多关心女朋友", isChecked: false },
    { text: "遇到喜欢的人主动出击", isChecked: false },
    { text: "开始学烘培", isChecked: false },
    { text: "拿下雅思/托福", isChecked: false },
    { text: "少说话，多做事", isChecked: false },
    { text: "上课不玩手机", isChecked: false },
    { text: "一个月不换微信头像", isChecked: false },
    { text: "成为能给周围人带来快乐的人", isChecked: false },
    { text: "谈一场不问结果的恋爱", isChecked: false },
    { text: "睡前玩手机不超过半小时", isChecked: false },
    { text: "去现场看LOL的总决赛", isChecked: false },
    { text: "2019年我会有猫的！", isChecked: false },
    { text: "看完50本书", isChecked: false },
    { text: "做个自律的人", isChecked: false },
    { text: "一定要当一回甲方！", isChecked: false },
    { text: "再也不吹牛了", isChecked: false },
    { text: "照顾好自己的身体", isChecked: false },
    { text: "坚持每天读书", isChecked: false },
    { text: "工资翻一番", isChecked: false },
    { text: "不再喝断片儿了", isChecked: false },
    { text: "毕业前绝不谈恋爱", isChecked: false },
    { text: "封印烦恼，放过自己", isChecked: false },
    { text: "每天坚持写日记", isChecked: false },
    { text: "中一次微博转发抽奖", isChecked: false },
    { text: "考上理想的学校", isChecked: false },
    { text: "刷完豆瓣电影top100", isChecked: false },
    { text: "不会再多管闲事了", isChecked: false },
    { text: "去香港维多利亚港跨年", isChecked: false },
    { text: "四级过过过！", isChecked: false },
    { text: "每天做一件让自己开心的事", isChecked: false },
    { text: "攒钱去植发", isChecked: false },
    { text: "换一份真正喜欢的工作", isChecked: false },
    { text: "多吃水果和蔬菜", isChecked: false },
    { text: "去打耳洞", isChecked: false },
    { text: "再也不纠结过去", isChecked: false },
    { text: "不对亲近的人发脾气", isChecked: false },
    { text: "多爱自己一点", isChecked: false },
    { text: "练出8块腹肌", isChecked: false },
    { text: "坚持不吃晚饭！", isChecked: false },
    { text: "坚决不赖床了", isChecked: false },
    { text: "一定要拿到理想公司的offer！", isChecked: false },
    { text: "我要瘦10斤", isChecked: false },
    { text: "周末不宅在家", isChecked: false },
    { text: "看完《莎士比亚全集》", isChecked: false },
    { text: "每个月给父母零花钱", isChecked: false },
    { text: "学会做饭，少点外卖", isChecked: false },
    { text: "再戒一次烟", isChecked: false },
    { text: "Get游泳技能", isChecked: false },
    { text: "去学街舞", isChecked: false },
    { text: "去百老汇看场音乐剧", isChecked: false },
    { text: "做一份清晰的职业规划", isChecked: false },
    { text: "坚持记账和存钱", isChecked: false },
    { text: "做回真正的自己", isChecked: false },
    { text: "练一手好看的字", isChecked: false },
    { text: "自学photoshop", isChecked: false },
    { text: "每天精读一篇英文外刊", isChecked: false },
    { text: "平衡好工作与生活", isChecked: false },
    { text: "不再乱买东西", isChecked: false },
    { text: "方案要一次过！", isChecked: false },
    { text: "征服司法考试", isChecked: false },
    { text: "把头发留长", isChecked: false },
    { text: "每天背30个单词", isChecked: false },
    { text: "看到胡歌结婚！", isChecked: false },
    { text: "今年一定要脱单", isChecked: false },
    { text: "学会管理情绪", isChecked: false },
    { text: "学会画眼线", isChecked: false },
    { text: "去看一次天空之镜", isChecked: false },
    { text: "不把负面情绪带给其他人", isChecked: false },
    { text: "不再轻易喜欢上一个人", isChecked: false },
    { text: "拥有一套属于自己的房子", isChecked: false },
    { text: "每天坚持吃早饭", isChecked: false },
    { text: "每天吃蔬菜", isChecked: false },
    { text: "学会滑雪", isChecked: false },
    { text: "去海上冲浪", isChecked: false },
    { text: "学会做饭，远离外卖", isChecked: false },
    { text: "再也不追剧了！", isChecked: false },
    { text: "完成2018年立下的flag", isChecked: false },
    { text: "世界那么大，我想去看看", isChecked: false },
    { text: "坚决不过光棍节！", isChecked: false },
    { text: "早点睡觉，不能手机砸脸了", isChecked: false },
    { text: "学会存钱，绝不月光", isChecked: false },
    { text: "撸至少十只猫", isChecked: false },
    { text: "打上王者排位", isChecked: false },
    { text: "感受一次当锦鲤的感觉", isChecked: false },
    { text: "逛遍能逛的所有博物馆", isChecked: false },
    { text: "培养一种业务爱好", isChecked: false },
    { text: "说话变温柔", isChecked: false },
    { text: "谈一场以结婚为目的的恋爱", isChecked: false },
    { text: "做个双眼皮手术", isChecked: false },
    { text: "拥有一台属于自己的车", isChecked: false },
    { text: "改掉我的拖延症", isChecked: false },
    { text: "节约用电用水，保护环境", isChecked: false },
    { text: "写完一本书", isChecked: false },
    { text: "做到经济独立", isChecked: false },
    { text: "看完电影写影评", isChecked: false },
    { text: "瘦到S码，穿美美的衣服", isChecked: false },
    { text: "定个小目标，先赚他一个亿", isChecked: false },
    { text: "把字练好看", isChecked: false },
    { text: "纹一个很酷的纹身", isChecked: false },
    { text: "至少爬过五座山", isChecked: false }
];
var setAd = function(dom) {
    var platform = phonePlatform();
    platform = platform == "iphone" ? "iphone" : "android";
    var adRandom = Math.floor(Math.random() * adData.length);
    var url = adData[adRandom][platform];
    dom.attr("href", url);
    dom.html(
        '<img src="./images/ad_small' +
            adRandom +
            "." +
            adData[adRandom].imageType +
            '" />'
    );
};

var adBoxs = $(".ad_box");
adBoxs.each(function() {
    setAd($(this));
});

function setQrcode() {
    new QRCode(document.getElementById("qrcodeBox"), {
        text: window.location.href
    });
}
function setTime() {
    var now = new Date();
    var to = new Date("2019/02/04 23:59:59");
    var s = to.getTime() - now.getTime();
    var res = {};
    let day = s / (1000 * 60 * 60 * 24);
    res.day = Math.floor(day, 10);
    res.hours = Math.floor((s / (1000 * 60 * 60)) % 24, 10);
    res.mins = Math.floor((s / (1000 * 60)) % 60, 10);
    res.secs = Math.floor((s / 1000) % 60, 10);
    res.day = res.day > 10 ? res.day : "0" + res.day;
    res.hours = res.hours >= 10 ? res.hours : "0" + res.hours;
    res.mins = res.mins >= 10 ? res.mins : "0" + res.mins;
    res.secs = res.secs >= 10 ? res.secs : "0" + res.secs;
    return res;
}

var time = setTime();
var renderObj = {
    show: "step1",
    date: time,
    showTab: "tab1",
    tabData: [],
    checkedData: [],
    userName: "",
    checkedByList: [],
    unCheckedList: []
};
var newObject = {};
var lookRenderObj = function() {
    function objectHandler(obj, key) {
        switch (key) {
            case "show":
                $(".page").removeClass("show");
                $("#" + obj[key]).addClass("show");
                break;
            case "showTab":
                $(".tab").removeClass("show");
                $("#" + obj[key]).addClass("show");
                break;
            case "date":
                var date = obj[key];
                for (var k in date) {
                    $("#" + k + "Number").html(date[k]);
                }
                break;
            case "tabData":
                var data = obj[key];
                var res = [];
                if (data && data.length > 0) {
                    data.map(function(item, index) {
                        res.push(
                            '<div class="checktab-item" data-index="item_' +
                                index +
                                '">' +
                                '<div class="text">' +
                                (index + 1) +
                                "." +
                                item.text +
                                "</div>" +
                                '<div class="checkbox">' +
                                (item.isChecked
                                    ? '<img src="./images/flag_check.png" />'
                                    : "") +
                                "</div>" +
                                "</div>"
                        );
                    });
                }
                $("#checkBox").html(res.join(""));
                break;
            case "checkedData":
                var data = obj[key];
                var res = [];
                var imgList = [];
                var checkedByList = [];
                if (data && data.length > 0) {
                    data.map(function(item, index) {
                        if (item.isChecked != undefined) {
                            checkedByList.push(item);
                        }
                        res.push(
                            '<div class="checked-item">' +
                                '<div class="text">' +
                                item.text +
                                "</div>" +
                                '<div class="delete" data-index="checkeditem_' +
                                index +
                                '">x</div>' +
                                "</div>"
                        );
                        imgList.push(
                            '<div class="item">' +
                                (index + 1) +
                                "." +
                                item.text +
                                "</div>"
                        );
                    });
                }
                $("#FlagList").html(imgList.join(""));
                $("#checkedNumber").html(data.length);
                $("#checkedBox").html(res.join(""));
                renderObj.checkedByList = JSON.parse(
                    JSON.stringify(checkedByList)
                );
                break;
            default:
                break;
        }
    }
    var newObject = renderObj ? JSON.parse(JSON.stringify(renderObj)) : {};
    delete renderObj;
    window.renderObj = {};
    Object.getOwnPropertyNames(newObject).forEach(
        function(k) {
            objectHandler(newObject, k);
            Object.defineProperty(renderObj, k, {
                get: function() {
                    return newObject[k];
                },
                set: function(value) {
                    newObject[k] = value;
                    objectHandler(newObject, k);
                }
            });
        }.bind(this)
    );
};

function getRandomList() {
    var res = [];
    for (var i = 6; i > 0; i--) {
        var d = getRandomItem(res);
        if (d) {
            res.push(d);
        }
    }
    return res;
}
function getRandomItem(array) {
    var tabList = renderObj.tabData;
    var uncheckButShow = 0;
    tabList.map(function(item) {
        if (!item.isChecked) {
            uncheckButShow++;
        }
    });
    if (
        renderObj.checkedByList.length + array.length + uncheckButShow >=
        flagDataList.length
    ) {
        return null;
    }
    var isHas = false;
    var randomNumber = Math.floor(Math.random() * flagDataList.length);
    var totalList = [].concat(
        renderObj.checkedData ? renderObj.checkedData : [],
        renderObj.tabData ? renderObj.tabData : [],
        array ? array : []
    );
    for (var i = 0, len = totalList.length; i < len; i++) {
        var item = totalList[i];
        if (flagDataList[randomNumber].text == item["text"]) {
            isHas = true;
        }
    }

    if (isHas) {
        return getRandomItem(array);
    }
    return flagDataList[randomNumber];
}
function drawImage() {
    html2canvas(document.querySelector("#willRenderImage"), {
        allowTaint: true,
        async: false,
        backgroundColor: "#f0dec1",
        scale: 3,
        dpi: window.devicePixelRatio * 2
    }).then(function(canvas) {
        var context = canvas.getContext("2d");
        context.mozImageSmoothingEnabled = false;
        context.webkitImageSmoothingEnabled = false;
        context.msImageSmoothingEnabled = false;
        context.imageSmoothingEnabled = false;
        var height = canvas.height;
        var width = canvas.width;
        context.clearRect(0, height - 2, width, height);
        var img = new Image();
        img.src = canvas.toDataURL("image/png");
        img.onload = function() {
            document.querySelector("#imgLayerBox").innerHTML = "";
            document.querySelector("#imgLayerBox").innerHTML =
                '<img class="canvasimg" src="' + img.src + '" />';
            document.querySelector("#willRenderImage").innerHTML = "";
            document.querySelector("#willRenderImage").innerHTML =
                '<img class="canvasimg" src="' + img.src + '" />';
            $.ajax({
                type: "post",
                url: "http://www.bxwjt.cn/api.php",
                data: {
                    title: "新年Flag",
                    desc: "新年Flag_flag",
                    image: img.src,
                    act: "set"
                },
                success: function(res) {
                    var data = JSON.parse(res);
                    if (data && data.code == "0000") {
                        wx.ready(function() {
                            var domain = getDomain();
                            var shareData = {
                                title: "新年Flag",
                                desc: "新年Flag",
                                link: domain + "/show.html?id=" + data.id,
                                imgUrl: domain + "/images/share.png",
                                success: function(res) {
                                    console.log(res);
                                }
                            };
                            wx.updateAppMessageShareData(shareData);
                            wx.updateTimelineShareData(shareData);
                        });
                        window.history.replaceState(
                            null,
                            "新年Flag",
                            "./show.html?id=" + data.id
                        );
                    }
                }
            });
        };
    });
}
var flagData = new lookRenderObj();
$(function() {
    setQrcode();
    renderObj.tabData = getRandomList();
    setInterval(
        function() {
            renderObj.date = setTime();
        }.bind(this, 1000)
    );
    $("#checkBox").on("click", ".checktab-item", function() {
        var _me = $(this);
        var _idx = _me.attr("data-index").split("_")[1];
        var list = renderObj.tabData;
        var checkList = renderObj.checkedData;
        list[_idx].isChecked = !list[_idx].isChecked;
        var newCheckList = [];
        if (!list[_idx].isChecked) {
            newCheckList = checkList.filter(function(item) {
                if (item.text != list[_idx].text) {
                    return item;
                }
            });
        } else {
            checkList.push(list[_idx]);
            newCheckList = checkList;
        }

        renderObj.tabData = JSON.parse(JSON.stringify(list));
        renderObj.checkedData = JSON.parse(JSON.stringify(newCheckList));
    });
    $("#tabHeader").on("click", function() {
        if (renderObj.showTab == "tab1") {
            renderObj.showTab = "tab2";
            $("#step2 .top").addClass("show");
        } else {
            renderObj.showTab = "tab1";
            $("#step2 .top").removeClass("show");
        }
    });
    $("#checkedBox").on("click", ".delete", function() {
        var _me = $(this);
        var _idx = _me.attr("data-index").split("_")[1];
        let list = renderObj.checkedData;
        var spItem = list.splice(_idx, 1);
        renderObj.checkedData = JSON.parse(JSON.stringify(list));
        var renderList = renderObj.tabData;
        renderList.map(function(item) {
            if (item.text == spItem[0].text) {
                item.isChecked = false;
            }
        });
        renderObj.tabData = JSON.parse(JSON.stringify(renderList));
    });
    $("#changeBtn").on("click", function() {
        renderObj.tabData = getRandomList();
    });
    $("#goStep2").on("click", function() {
        renderObj.show = "step2";
    });
    $("#customerAddBtn").on("click", function() {
        var _input = $("#inputBox");
        var _value = _input[0].value;
        if (_value.trim().length <= 0) {
            return;
        }
        var list = renderObj.checkedData;
        var isHave = false;
        for (var i = 0, l = list.length; i < l; i++) {
            if (list[i].text == _value.trim()) {
                isHave = true;
                break;
            }
        }
        if (isHave) {
            return;
        }

        list.push({
            text: _value.trim()
        });
        $("#inputBox").val("");
        renderObj.checkedData = JSON.parse(JSON.stringify(list));
        document.activeElement.scrollIntoViewIfNeeded(true);
    });
    //生成图片
    $("#saveBtn").on("click", function() {
        var saveBox = $("#saveBox");
        $("html,body").css({
            overflow: "hidden"
        });
        var imglayer = $("#imgLayerBox");
        saveBox.addClass("show");
        if (imglayer.html().length > 0) {
            return;
        }
    });
    $("#saveBox").on("click", function() {
        $(this).removeClass("show");
        $("html,body").css({
            overflow: "auto"
        });
    });
    $("#shareBtn").on("click", function() {
        $("#shareLayer").addClass("show");
    });
    $("#shareLayer").on("click", function() {
        $(this).removeClass("show");
    });
    $("#step3Btn").on("click", function() {
        var _value = $("#userNameInput")[0].value.trim();
        if (_value.length <= 0) {
            alert("请输入你的名字");
            return;
        }
        renderObj.show = "step5";
        renderObj.userName = _value;
        $("#userNameText").html(renderObj.userName);
        var date = new Date();
        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        var day = date.getDate();
        var hours = date.getHours();
        var mins = date.getMinutes();
        $("#flagTime").html(
            "立于" + year + "/" + month + "/" + day + "/ " + hours + ":" + mins
        );
        drawImage();
    });
    $("#step2Btn").on("click", function() {
        if (renderObj.checkedData.length <= 0) {
            alert("请选择你要立的Flag!");
            return;
        }
        renderObj.show = "step3";
    });
});
